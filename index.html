<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة طلبات العبوات البلاستيكية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            },
            darkMode: 'class',
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white text-center">نظام إدارة طلبات العبوات البلاستيكية</h1>
        </header>

        <!-- Auth Section -->
        <div id="authSection" class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8">
            <div id="loginForm" class="space-y-4">
                <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">تسجيل الدخول</h2>
                <div>
                    <label for="email" class="block text-gray-700 dark:text-gray-300 mb-1">البريد الإلكتروني</label>
                    <input type="email" id="email" name="email" required 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label for="password" class="block text-gray-700 dark:text-gray-300 mb-1">كلمة المرور</label>
                    <input type="password" id="password" name="password" required 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="flex space-x-2 space-x-reverse">
                    <button id="loginBtn" class="px-6 py-2 bg-primary hover:bg-primary/90 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors">
                        <i class="fas fa-sign-in-alt ml-1"></i>تسجيل الدخول
                    </button>
                    <button id="registerBtn" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors">
                        <i class="fas fa-user-plus ml-1"></i>تسجيل حساب جديد
                    </button>
                </div>
                <div id="authMessage" class="mt-2 text-sm"></div>
            </div>
            <div id="userInfo" class="hidden">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-white">مرحباً، <span id="userName">المستخدم</span></h2>
                        <p class="text-gray-600 dark:text-gray-400" id="userEmail">user@example.com</p>
                        <p class="text-gray-600 dark:text-gray-400">الدور: <span id="userRole">مستخدم</span></p>
                    </div>
                    <button id="logoutBtn" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md shadow-sm focus:outline-none">
                        <i class="fas fa-sign-out-alt ml-1"></i>تسجيل الخروج
                    </button>
                </div>
            </div>
        </div>

        <div id="appContent" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Order Form -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">طلب تصنيع عبوات</h2>
                    <form id="orderForm" class="space-y-4">
                        <div>
                            <label for="customerName" class="block text-gray-700 dark:text-gray-300 mb-1">اسم العميل</label>
                            <input type="text" id="customerName" name="customerName" required 
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>

                        <div>
                            <label for="size" class="block text-gray-700 dark:text-gray-300 mb-1">المقاس</label>
                            <select id="size" name="size" required
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">اختر المقاس</option>
                                <option value="صغير">صغير</option>
                                <option value="متوسط">متوسط</option>
                                <option value="كبير">كبير</option>
                                <option value="مخصص">مخصص</option>
                            </select>
                        </div>

                        <div>
                            <label for="color" class="block text-gray-700 dark:text-gray-300 mb-1">اللون</label>
                            <select id="color" name="color" required
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">اختر اللون</option>
                                <option value="أبيض">أبيض</option>
                                <option value="أسود">أسود</option>
                                <option value="أزرق">أزرق</option>
                                <option value="أحمر">أحمر</option>
                                <option value="أخضر">أخضر</option>
                                <option value="شفاف">شفاف</option>
                            </select>
                        </div>

                        <div>
                            <label for="printMethod" class="block text-gray-700 dark:text-gray-300 mb-1">طريقة الطباعة</label>
                            <select id="printMethod" name="printMethod" required
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">اختر طريقة الطباعة</option>
                                <option value="أوفست">أوفست</option>
                                <option value="سلك سكرين">سلك سكرين</option>
                                <option value="فلكسو">فلكسو</option>
                                <option value="رقمية">رقمية</option>
                                <option value="بدون طباعة">بدون طباعة</option>
                            </select>
                        </div>

                        <div>
                            <label for="handle" class="block text-gray-700 dark:text-gray-300 mb-1">بيد / بدون يد</label>
                            <select id="handle" name="handle" required
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">اختر النوع</option>
                                <option value="بيد">بيد</option>
                                <option value="بدون يد">بدون يد</option>
                            </select>
                        </div>

                        <div>
                            <label for="quantity" class="block text-gray-700 dark:text-gray-300 mb-1">العدد المطلوب</label>
                            <input type="number" id="quantity" name="quantity" min="1" required
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>

                        <div>
                            <label for="paymentTerms" class="block text-gray-700 dark:text-gray-300 mb-1">شروط الدفع</label>
                            <textarea id="paymentTerms" name="paymentTerms" rows="2" required
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                        </div>

                        <div>
                            <label for="deliveryDate" class="block text-gray-700 dark:text-gray-300 mb-1">تاريخ التسليم</label>
                            <input type="date" id="deliveryDate" name="deliveryDate" required
                                class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>

                        <div class="flex flex-wrap gap-3 pt-2">
                            <button type="submit" id="submitBtn" class="px-6 py-2 bg-primary hover:bg-primary/90 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors">
                                <i class="fas fa-paper-plane ml-1"></i>إرسال الطلب
                            </button>
                            <button type="reset" id="resetBtn" class="px-6 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 transition-colors">
                                <i class="fas fa-redo-alt ml-1"></i>إعادة تعيين
                            </button>
                            <button type="button" id="exportDataBtn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-green-600 focus:ring-offset-2 transition-colors">
                                <i class="fas fa-file-export ml-1"></i>تصدير البيانات
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Orders Management Section -->
                <div class="flex flex-col space-y-6">
                    <!-- Status & Notifications -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-white">حالة الطلبات</h2>
                        <div id="notifications" class="space-y-3">
                            <!-- Notifications will be displayed here -->
                        </div>
                    </div>

                    <!-- Data Table -->
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 overflow-x-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-gray-800 dark:text-white">جدول الطلبات</h2>
                            <div class="flex space-x-2 space-x-reverse">
                                <button id="togglePendingBtn" class="px-3 py-1 bg-yellow-500 hover:bg-yellow-600 text-white rounded-md shadow-sm focus:outline-none text-sm">
                                    الطلبات المعلقة
                                </button>
                                <button id="toggleApprovedBtn" class="px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded-md shadow-sm focus:outline-none text-sm">
                                    الطلبات المقبولة
                                </button>
                                <button id="toggleRejectedBtn" class="px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-md shadow-sm focus:outline-none text-sm">
                                    الطلبات المرفوضة
                                </button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">رقم الطلب</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">اسم العميل</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الكمية</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">تاريخ التسليم</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الأيام المتبقية</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">الحالة</th>
                                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">إجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="ordersTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Orders will be displayed here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Details Modal -->
        <div id="orderDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white">تفاصيل الطلب</h3>
                    <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div id="orderDetailsContent" class="space-y-4">
                    <!-- Order details will be shown here -->
                </div>
                <div class="flex mt-6 gap-3" id="orderActionButtons">
                    <!-- Action buttons will be added here -->
                </div>
            </div>
        </div>

        <!-- Register Modal -->
        <div id="registerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white">تسجيل حساب جديد</h3>
                    <button id="closeRegisterModalBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <form id="registerForm" class="space-y-4">
                    <div>
                        <label for="registerName" class="block text-gray-700 dark:text-gray-300 mb-1">الاسم</label>
                        <input type="text" id="registerName" name="registerName" required 
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="registerEmail" class="block text-gray-700 dark:text-gray-300 mb-1">البريد الإلكتروني</label>
                        <input type="email" id="registerEmail" name="registerEmail" required 
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="registerPassword" class="block text-gray-700 dark:text-gray-300 mb-1">كلمة المرور</label>
                        <input type="password" id="registerPassword" name="registerPassword" required minlength="6"
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                    <div>
                        <label for="registerRole" class="block text-gray-700 dark:text-gray-300 mb-1">الدور</label>
                        <select id="registerRole" name="registerRole" required
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-base bg-white dark:bg-gray-700 text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary">
                            <option value="user">مستخدم</option>
                            <option value="approver">مشرف موافقات</option>
                            <option value="admin">مدير</option>
                        </select>
                    </div>
                    <div id="registerMessage" class="text-sm"></div>
                    <button type="submit" class="w-full px-6 py-2 bg-primary hover:bg-primary/90 text-white rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 transition-colors">
                        <i class="fas fa-user-plus ml-1"></i>تسجيل
                    </button>
                </form>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-primary"></div>
                    <span class="text-lg font-medium text-gray-700 dark:text-gray-300 mr-3">جاري المعالجة...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Firebase configuration
        // NOTE: You'll need to replace these values with your own Firebase project configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Collections
        const ordersCollection = db.collection('orders');
        const usersCollection = db.collection('users');
        
        // Current user object
        let currentUser = null;

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const loginForm = document.getElementById('loginForm');
        const userInfo = document.getElementById('userInfo');
        const appContent = document.getElementById('appContent');
        const orderForm = document.getElementById('orderForm');
        const ordersTableBody = document.getElementById('ordersTableBody');
        const notificationsContainer = document.getElementById('notifications');
        const orderDetailsModal = document.getElementById('orderDetailsModal');
        const orderDetailsContent = document.getElementById('orderDetailsContent');
        const orderActionButtons = document.getElementById('orderActionButtons');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const togglePendingBtn = document.getElementById('togglePendingBtn');
        const toggleApprovedBtn = document.getElementById('toggleApprovedBtn');
        const toggleRejectedBtn = document.getElementById('toggleRejectedBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userName = document.getElementById('userName');
        const userEmail = document.getElementById('userEmail');
        const userRole = document.getElementById('userRole');
        const authMessage = document.getElementById('authMessage');
        const registerModal = document.getElementById('registerModal');
        const registerForm = document.getElementById('registerForm');
        const closeRegisterModalBtn = document.getElementById('closeRegisterModalBtn');
        const registerMessage = document.getElementById('registerMessage');
        
        // Filter state
        let showPending = true;
        let showApproved = true;
        let showRejected = true;

        // Initialize the application
        function init() {
            // Add event listeners
            addEventListeners();
            
            // Set up Firebase auth state listener
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    showLoading();
                    try {
                        // Get user data from Firestore
                        const userDoc = await usersCollection.doc(user.uid).get();
                        
                        if (userDoc.exists) {
                            currentUser = {
                                id: user.uid,
                                email: user.email,
                                ...userDoc.data()
                            };
                            
                            // Update UI
                            showUserInfo();
                            
                            // Fetch orders
                            fetchOrders();
                        } else {
                            // Create user document if it doesn't exist
                            await usersCollection.doc(user.uid).set({
                                name: user.displayName || 'مستخدم',
                                email: user.email,
                                role: 'user',
                                createdAt: new Date()
                            });
                            
                            currentUser = {
                                id: user.uid,
                                email: user.email,
                                name: user.displayName || 'مستخدم',
                                role: 'user'
                            };
                            
                            // Update UI
                            showUserInfo();
                            
                            // Fetch orders
                            fetchOrders();
                        }
                    } catch (error) {
                        console.error("Error getting user data:", error);
                        addNotification("حدث خطأ أثناء تحميل بيانات المستخدم", "error");
                        auth.signOut();
                    } finally {
                        hideLoading();
                    }
                } else {
                    // User is signed out
                    currentUser = null;
                    showLoginForm();
                }
            });
        }

        // Add event listeners
        function addEventListeners() {
            // Auth event listeners
            loginBtn.addEventListener('click', handleLogin);
            registerBtn.addEventListener('click', () => {
                registerModal.classList.remove('hidden');
            });
            logoutBtn.addEventListener('click', handleLogout);
            closeRegisterModalBtn.addEventListener('click', () => {
                registerModal.classList.add('hidden');
            });
            registerForm.addEventListener('submit', handleRegister);
            
            // Form submission
            orderForm.addEventListener('submit', handleFormSubmit);
            
            // Modal close button
            closeModalBtn.addEventListener('click', () => {
                orderDetailsModal.classList.add('hidden');
            });
            
            // Filter buttons
            togglePendingBtn.addEventListener('click', () => {
                showPending = !showPending;
                togglePendingBtn.classList.toggle('bg-yellow-500');
                togglePendingBtn.classList.toggle('bg-gray-400');
                renderOrders();
            });
            
            toggleApprovedBtn.addEventListener('click', () => {
                showApproved = !showApproved;
                toggleApprovedBtn.classList.toggle('bg-green-500');
                toggleApprovedBtn.classList.toggle('bg-gray-400');
                renderOrders();
            });
            
            toggleRejectedBtn.addEventListener('click', () => {
                showRejected = !showRejected;
                toggleRejectedBtn.classList.toggle('bg-red-500');
                toggleRejectedBtn.classList.toggle('bg-gray-400');
                renderOrders();
            });
            
            // Export data
            exportDataBtn.addEventListener('click', exportOrdersToJSON);
        }

        // Handle login
        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                setAuthMessage("يرجى إدخال البريد الإلكتروني وكلمة المرور", "error");
                return;
            }
            
            showLoading();
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                setAuthMessage("", "");
            } catch (error) {
                console.error("Error signing in:", error);
                let errorMessage = "حدث خطأ أثناء تسجيل الدخول";
                
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "البريد الإلكتروني أو كلمة المرور غير صحيحة";
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = "تم حظر الحساب مؤقتاً بسبب كثرة المحاولات الفاشلة. حاول مرة أخرى لاحقاً";
                        break;
                }
                
                setAuthMessage(errorMessage, "error");
            } finally {
                hideLoading();
            }
        }

        // Handle register
        async function handleRegister(e) {
            e.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const role = document.getElementById('registerRole').value;
            
            if (!name || !email || !password) {
                setRegisterMessage("يرجى تعبئة جميع الحقول", "error");
                return;
            }
            
            showLoading();
            
            try {
                // Create user with email and password
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Create user document in Firestore
                await usersCollection.doc(user.uid).set({
                    name,
                    email,
                    role,
                    createdAt: new Date()
                });
                
                // Close register modal
                registerModal.classList.add('hidden');
                setRegisterMessage("", "");
                
                // Reset form
                registerForm.reset();
                
                addNotification("تم تسجيل الحساب بنجاح", "success");
            } catch (error) {
                console.error("Error registering:", error);
                let errorMessage = "حدث خطأ أثناء تسجيل الحساب";
                
                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = "هذا البريد الإلكتروني مستخدم بالفعل";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "البريد الإلكتروني غير صالح";
                        break;
                    case 'auth/weak-password':
                        errorMessage = "كلمة المرور ضعيفة جداً";
                        break;
                }
                
                setRegisterMessage(errorMessage, "error");
            } finally {
                hideLoading();
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                await auth.signOut();
                addNotification("تم تسجيل الخروج بنجاح", "info");
            } catch (error) {
                console.error("Error signing out:", error);
                addNotification("حدث خطأ أثناء تسجيل الخروج", "error");
            }
        }

        // Show login form
        function showLoginForm() {
            loginForm.classList.remove('hidden');
            userInfo.classList.add('hidden');
            appContent.classList.add('hidden');
        }

        // Show user info
        function showUserInfo() {
            loginForm.classList.add('hidden');
            userInfo.classList.remove('hidden');
            appContent.classList.remove('hidden');
            
            // Update user info
            userName.textContent = currentUser.name;
            userEmail.textContent = currentUser.email;
            userRole.textContent = translateRole(currentUser.role);
        }

        // Translate role to Arabic
        function translateRole(role) {
            switch (role) {
                case 'admin': return 'مدير';
                case 'approver': return 'مشرف موافقات';
                case 'user': return 'مستخدم';
                default: return role;
            }
        }

        // Set auth message
        function setAuthMessage(message, type) {
            authMessage.textContent = message;
            authMessage.className = 'mt-2 text-sm';
            
            if (type === 'error') {
                authMessage.classList.add('text-red-600', 'dark:text-red-400');
            } else if (type === 'success') {
                authMessage.classList.add('text-green-600', 'dark:text-green-400');
            }
        }

        // Set register message
        function setRegisterMessage(message, type) {
            registerMessage.textContent = message;
            registerMessage.className = 'text-sm';
            
            if (type === 'error') {
                registerMessage.classList.add('text-red-600', 'dark:text-red-400');
            } else if (type === 'success') {
                registerMessage.classList.add('text-green-600', 'dark:text-green-400');
            }
        }

        // Fetch orders from Firestore
        async function fetchOrders() {
            showLoading();
            
            try {
                const snapshot = await ordersCollection.orderBy('createdAt', 'desc').get();
                const fetchedOrders = [];
                
                snapshot.forEach(doc => {
                    fetchedOrders.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Update UI
                renderOrders(fetchedOrders);
                addNotification("تم تحميل البيانات بنجاح", "success");
            } catch (error) {
                console.error("Error fetching orders:", error);
                addNotification("حدث خطأ أثناء تحميل البيانات", "error");
            } finally {
                hideLoading();
            }
        }

        // Handle form submission
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                addNotification("يجب تسجيل الدخول أولاً", "error");
                return;
            }
            
            // Check if user has permission to create orders
            if (currentUser.role !== 'admin' && currentUser.role !== 'user') {
                addNotification("ليس لديك صلاحية لإنشاء طلبات جديدة", "error");
                return;
            }
            
            // Get form data
            const formData = new FormData(orderForm);
            const orderData = {
                customerName: formData.get('customerName'),
                size: formData.get('size'),
                color: formData.get('color'),
                printMethod: formData.get('printMethod'),
                handle: formData.get('handle'),
                quantity: parseInt(formData.get('quantity')),
                paymentTerms: formData.get('paymentTerms'),
                deliveryDate: formData.get('deliveryDate'),
                status: "pending",
                createdBy: {
                    id: currentUser.id,
                    name: currentUser.name,
                    email: currentUser.email
                },
                createdAt: new Date(),
                approvalHistory: []
            };
            
            showLoading();
            
            try {
                // Add order to Firestore
                const docRef = await ordersCollection.add(orderData);
                
                // Reset the form
                orderForm.reset();
                
                // Fetch orders to update the table
                fetchOrders();
                
                // Show notification
                addNotification(`تم إرسال الطلب بنجاح وينتظر الموافقة`, "success");
                
                // Simulate sending approval request to team
                simulateTeamRequestSent(docRef.id);
            } catch (error) {
                console.error("Error adding order:", error);
                addNotification("حدث خطأ أثناء إضافة الطلب", "error");
                hideLoading();
            }
        }

        // Calculate days remaining until delivery
        function calculateDaysRemaining(deliveryDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const delivery = new Date(deliveryDate);
            delivery.setHours(0, 0, 0, 0);
            
            const diffTime = delivery - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        // Render orders in the table
        function renderOrders(orders) {
            // Clear the table
            ordersTableBody.innerHTML = '';
            
            if (!orders || orders.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" class="px-4 py-3 text-center text-gray-500 dark:text-gray-400">لا توجد طلبات</td>
                `;
                ordersTableBody.appendChild(emptyRow);
                return;
            }
            
            // Filter orders based on toggle buttons
            const filteredOrders = orders.filter(order => {
                if (order.status === 'pending' && !showPending) return false;
                if (order.status === 'approved' && !showApproved) return false;
                if (order.status === 'rejected' && !showRejected) return false;
                return true;
            });
            
            if (filteredOrders.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" class="px-4 py-3 text-center text-gray-500 dark:text-gray-400">لا توجد طلبات تطابق المعايير المحددة</td>
                `;
                ordersTableBody.appendChild(emptyRow);
                return;
            }
            
            // Add each order to the table
            filteredOrders.forEach(order => {
                const daysRemaining = calculateDaysRemaining(order.deliveryDate);
                const daysRemainingClass = daysRemaining < 0 ? 'text-red-500' : 
                                          daysRemaining < 3 ? 'text-yellow-500' : 'text-green-500';
                
                // Format date for display
                const formattedDeliveryDate = new Date(order.deliveryDate).toLocaleDateString('ar-SA');
                
                // Status classes and text
                let statusClass, statusText;
                
                switch(order.status) {
                    case 'pending':
                        statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
                        statusText = 'قيد الانتظار';
                        break;
                    case 'approved':
                        statusClass = 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
                        statusText = 'تمت الموافقة';
                        break;
                    case 'rejected':
                        statusClass = 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
                        statusText = 'مرفوض';
                        break;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${order.id.substring(0, 8)}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${order.customerName}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${order.quantity.toLocaleString('ar-SA')}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${formattedDeliveryDate}</td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm font-semibold ${daysRemainingClass}">${daysRemaining > 0 ? daysRemaining : 'متأخر'}</td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        <button class="text-primary hover:text-primary/80 dark:text-blue-400 dark:hover:text-blue-300 view-btn" data-id="${order.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${(currentUser.role === 'admin' || currentUser.role === 'approver') && order.status === 'pending' ? `
                        <button class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 mr-3 approve-btn" data-id="${order.id}">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 mr-3 reject-btn" data-id="${order.id}">
                            <i class="fas fa-times"></i>
                        </button>
                        ` : ''}
                        ${currentUser.role === 'admin' ? `
                        <button class="text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 mr-3 delete-btn" data-id="${order.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                `;
                
                ordersTableBody.appendChild(row);
            });
            
            // Add event listeners to the buttons
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => showOrderDetails(btn.dataset.id));
            });
            
            document.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', () => approveOrder(btn.dataset.id));
            });
            
            document.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', () => rejectOrder(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteOrder(btn.dataset.id));
            });
        }

        // Show order details in a modal
        async function showOrderDetails(orderId) {
            showLoading();
            
            try {
                // Get order from Firestore
                const doc = await ordersCollection.doc(orderId).get();
                
                if (!doc.exists) {
                    addNotification("لم يتم العثور على الطلب", "error");
                    hideLoading();
                    return;
                }
                
                const order = {
                    id: doc.id,
                    ...doc.data()
                };
                
                // Format dates
                const createdAtDate = order.createdAt.toDate().toLocaleString('ar-SA');
                const deliveryDate = new Date(order.deliveryDate).toLocaleDateString('ar-SA');
                const daysRemaining = calculateDaysRemaining(order.deliveryDate);
                
                // Status text
                let statusText;
                switch(order.status) {
                    case 'pending': statusText = 'قيد الانتظار'; break;
                    case 'approved': statusText = 'تمت الموافقة'; break;
                    case 'rejected': statusText = 'مرفوض'; break;
                }
                
                // Generate approval history HTML
                let approvalHistoryHTML = '';
                if (order.approvalHistory && order.approvalHistory.length > 0) {
                    approvalHistoryHTML = `
                    <div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                        <h4 class="font-semibold text-gray-700 dark:text-gray-300 mb-2">سجل الموافقة</h4>
                        <ul class="space-y-2">
                    `;
                    
                    order.approvalHistory.forEach(history => {
                        const actionText = history.action === 'approve' ? 'موافقة' : 'رفض';
                        const actionClass = history.action === 'approve' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                        const historyDate = history.at.toDate().toLocaleString('ar-SA');
                        
                        approvalHistoryHTML += `
                            <li class="text-gray-600 dark:text-gray-400 text-sm">
                                <span class="font-medium ${actionClass}">${actionText}</span> بواسطة 
                                <span class="font-medium">${history.by.name}</span> 
                                <span>(${history.by.email})</span> في 
                                <span>${historyDate}</span>
                                <p class="mt-1">${history.comments}</p>
                            </li>
                        `;
                    });
                    
                    approvalHistoryHTML += `
                        </ul>
                    </div>
                    `;
                }
                
                // Set modal content
                orderDetailsContent.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">رقم الطلب</p>
                            <p class="text-gray-900 dark:text-white font-medium">${order.id}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">الحالة</p>
                            <p class="text-gray-900 dark:text-white font-medium">${statusText}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">اسم العميل</p>
                            <p class="text-gray-900 dark:text-white font-medium">${order.customerName}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">المقاس</p>
                            <p class="text-gray-900 dark:text-white font-medium">${order.size}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">اللون</p>
                            <p class="text-gray-900 dark:text-white font-medium">${order.color}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">طريقة الطباعة</p>
                            <p class="text-gray-900 dark:text-white font-medium">${order.printMethod}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">النوع</p>
                            <p class="text-gray-900 dark:text-white font-medium">${order.handle}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">الكمية</p>
                            <p class="text-gray-900 dark:text-white font-medium">${order.quantity.toLocaleString('ar-SA')}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">تاريخ التسليم</p>
                            <p class="text-gray-900 dark:text-white font-medium">${deliveryDate}</p>
                        </div>
                        <div>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">الأيام المتبقية</p>
                            <p class="text-gray-900 dark:text-white font-medium">${daysRemaining > 0 ? daysRemaining : 'متأخر'}</p>
                        </div>
                    </div>
                    <div class="mt-4">
                        <p class="text-gray-500 dark:text-gray-400 text-sm">شروط الدفع</p>
                        <p class="text-gray-900 dark:text-white font-medium">${order.paymentTerms}</p>
                    </div>
                    <div class="mt-4 border-t border-gray-200 dark:border-gray-700 pt-4">
                        <p class="text-gray-500 dark:text-gray-400 text-sm">أنشئ بواسطة</p>
                        <p class="text-gray-900 dark:text-white font-medium">${order.createdBy.name} (${order.createdBy.email})</p>
                        <p class="text-gray-500 dark:text-gray-400 text-sm mt-1">تاريخ الإنشاء</p>
                        <p class="text-gray-900 dark:text-white font-medium">${createdAtDate}</p>
                    </div>
                    ${approvalHistoryHTML}
                `;
                
                // Set action buttons based on order status and user role
                orderActionButtons.innerHTML = '';
                if (order.status === 'pending' && (currentUser.role === 'admin' || currentUser.role === 'approver')) {
                    const approveButton = document.createElement('button');
                    approveButton.className = 'px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md shadow-sm focus:outline-none';
                    approveButton.innerHTML = '<i class="fas fa-check mr-1"></i>موافقة';
                    approveButton.addEventListener('click', () => {
                        orderDetailsModal.classList.add('hidden');
                        approveOrder(order.id);
                    });
                    
                    const rejectButton = document.createElement('button');
                    rejectButton.className = 'px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-md shadow-sm focus:outline-none';
                    rejectButton.innerHTML = '<i class="fas fa-times mr-1"></i>رفض';
                    rejectButton.addEventListener('click', () => {
                        orderDetailsModal.classList.add('hidden');
                        rejectOrder(order.id);
                    });
                    
                    orderActionButtons.appendChild(approveButton);
                    orderActionButtons.appendChild(rejectButton);
                }
                
                // Show modal
                orderDetailsModal.classList.remove('hidden');
            } catch (error) {
                console.error("Error fetching order details:", error);
                addNotification("حدث خطأ أثناء تحميل تفاصيل الطلب", "error");
            } finally {
                hideLoading();
            }
        }

        // Approve order
        async function approveOrder(orderId) {
            if (!currentUser) {
                addNotification("يجب تسجيل الدخول أولاً", "error");
                return;
            }
            
            // Check if user has permission to approve orders
            if (currentUser.role !== 'admin' && currentUser.role !== 'approver') {
                addNotification("ليس لديك صلاحية للموافقة على الطلبات", "error");
                return;
            }
            
            if (!confirm("هل أنت متأكد من الموافقة على هذا الطلب؟")) {
                return;
            }
            
            showLoading();
            
            try {
                // Get current order
                const doc = await ordersCollection.doc(orderId).get();
                
                if (!doc.exists) {
                    addNotification("لم يتم العثور على الطلب", "error");
                    hideLoading();
                    return;
                }
                
                // Update order status
                await ordersCollection.doc(orderId).update({
                    status: 'approved',
                    approvalHistory: firebase.firestore.FieldValue.arrayUnion({
                        action: 'approve',
                        by: {
                            id: currentUser.id,
                            name: currentUser.name,
                            email: currentUser.email
                        },
                        at: new Date(),
                        comments: "تمت الموافقة على الطلب وجدولته للإنتاج"
                    })
                });
                
                // Fetch orders to update the table
                fetchOrders();
                
                // Show notification
                addNotification(`تمت الموافقة على الطلب بنجاح`, "success");
                
                // Simulate team notification
                simulateTeamNotification(orderId, 'approved');
            } catch (error) {
                console.error("Error approving order:", error);
                addNotification("حدث خطأ أثناء الموافقة على الطلب", "error");
                hideLoading();
            }
        }

        // Reject order
        async function rejectOrder(orderId) {
            if (!currentUser) {
                addNotification("يجب تسجيل الدخول أولاً", "error");
                return;
            }
            
            // Check if user has permission to reject orders
            if (currentUser.role !== 'admin' && currentUser.role !== 'approver') {
                addNotification("ليس لديك صلاحية لرفض الطلبات", "error");
                return;
            }
            
            const reason = prompt("يرجى إدخال سبب الرفض:");
            
            if (reason === null) {
                return;
            }
            
            showLoading();
            
            try {
                // Get current order
                const doc = await ordersCollection.doc(orderId).get();
                
                if (!doc.exists) {
                    addNotification("لم يتم العثور على الطلب", "error");
                    hideLoading();
                    return;
                }
                
                // Update order status
                await ordersCollection.doc(orderId).update({
                    status: 'rejected',
                    approvalHistory: firebase.firestore.FieldValue.arrayUnion({
                        action: 'reject',
                        by: {
                            id: currentUser.id,
                            name: currentUser.name,
                            email: currentUser.email
                        },
                        at: new Date(),
                        comments: reason || "تم رفض الطلب"
                    })
                });
                
                // Fetch orders to update the table
                fetchOrders();
                
                // Show notification
                addNotification(`تم رفض الطلب`, "error");
                
                // Simulate team notification
                simulateTeamNotification(orderId, 'rejected');
            } catch (error) {
                console.error("Error rejecting order:", error);
                addNotification("حدث خطأ أثناء رفض الطلب", "error");
                hideLoading();
            }
        }

        // Delete order
        async function deleteOrder(orderId) {
            if (!currentUser) {
                addNotification("يجب تسجيل الدخول أولاً", "error");
                return;
            }
            
            // Check if user has permission to delete orders
            if (currentUser.role !== 'admin') {
                addNotification("ليس لديك صلاحية لحذف الطلبات", "error");
                return;
            }
            
            if (!confirm("هل أنت متأكد من حذف هذا الطلب؟ لا يمكن التراجع عن هذا الإجراء.")) {
                return;
            }
            
            showLoading();
            
            try {
                // Delete order from Firestore
                await ordersCollection.doc(orderId).delete();
                
                // Fetch orders to update the table
                fetchOrders();
                
                // Show notification
                addNotification(`تم حذف الطلب بنجاح`, "info");
            } catch (error) {
                console.error("Error deleting order:", error);
                addNotification("حدث خطأ أثناء حذف الطلب", "error");
                hideLoading();
            }
        }

        // Export orders to JSON
        function exportOrdersToJSON() {
            if (!currentUser) {
                addNotification("يجب تسجيل الدخول أولاً", "error");
                return;
            }
            
            showLoading();
            
            ordersCollection.get().then(snapshot => {
                const orders = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Convert timestamps to strings for JSON
                    const order = {
                        id: doc.id,
                        customerName: data.customerName,
                        size: data.size,
                        color: data.color,
                        printMethod: data.printMethod,
                        handle: data.handle,
                        quantity: data.quantity,
                        paymentTerms: data.paymentTerms,
                        deliveryDate: data.deliveryDate,
                        status: data.status,
                        createdBy: data.createdBy,
                        createdAt: data.createdAt.toDate().toISOString(),
                        approvalHistory: data.approvalHistory ? data.approvalHistory.map(h => ({
                            ...h,
                            at: h.at.toDate().toISOString()
                        })) : []
                    };
                    
                    orders.push(order);
                });
                
                // Create JSON data
                const jsonData = JSON.stringify(orders, null, 2);
                
                // Create a popup with the JSON data
                const pre = document.createElement('pre');
                pre.className = 'bg-gray-100 dark:bg-gray-700 p-4 rounded-md overflow-auto text-gray-800 dark:text-gray-200 text-xs max-h-96';
                pre.textContent = jsonData;
                
                const exportDiv = document.createElement('div');
                exportDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                exportDiv.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg max-w-4xl w-full p-6 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-white">بيانات الطلبات (JSON)</h3>
                            <button id="closeExportBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
                                <i class="fas fa-times text-xl"></i>
                            </button>
                        </div>
                        <div>
                            <p class="text-gray-600 dark:text-gray-400 mb-4">يمكنك نسخ هذه البيانات أو حفظها كملف JSON.</p>
                            <button id="copyJsonBtn" class="px-4 py-2 bg-primary hover:bg-primary/90 text-white rounded-md shadow-sm focus:outline-none mb-4">
                                <i class="fas fa-copy mr-1"></i>نسخ البيانات
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(exportDiv);
                const contentDiv = exportDiv.querySelector('div > div:nth-child(2)');
                contentDiv.appendChild(pre);
                
                // Add event listener to close button
                const closeBtn = document.getElementById('closeExportBtn');
                closeBtn.addEventListener('click', () => {
                    exportDiv.remove();
                });
                
                // Add event listener to copy button
                const copyBtn = document.getElementById('copyJsonBtn');
                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(jsonData)
                        .then(() => {
                            copyBtn.innerHTML = '<i class="fas fa-check mr-1"></i>تم النسخ';
                            copyBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
                            copyBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                            
                            setTimeout(() => {
                                copyBtn.innerHTML = '<i class="fas fa-copy mr-1"></i>نسخ البيانات';
                                copyBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                                copyBtn.classList.add('bg-primary', 'hover:bg-primary/90');
                            }, 2000);
                        })
                        .catch(err => {
                            addNotification("حدث خطأ أثناء نسخ البيانات", "error");
                            console.error('Could not copy text: ', err);
                        });
                });
                
                hideLoading();
                addNotification("تم تصدير البيانات بنجاح", "success");
            }).catch(error => {
                console.error("Error exporting orders:", error);
                addNotification("حدث خطأ أثناء تصدير البيانات", "error");
                hideLoading();
            });
        }

        // Add notification
        function addNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `p-3 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' :
                type === 'error' ? 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200' :
                'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
            }`;
            
            const timestamp = new Date().toLocaleTimeString('ar-SA');
            
            notification.innerHTML = `
                <div class="flex justify-between">
                    <div>
                        <i class="fas ${
                            type === 'success' ? 'fa-check-circle text-green-600 dark:text-green-400' :
                            type === 'error' ? 'fa-exclamation-circle text-red-600 dark:text-red-400' :
                            'fa-info-circle text-blue-600 dark:text-blue-400'
                        } ml-2"></i>
                        ${message}
                    </div>
                    <span class="text-xs">${timestamp}</span>
                </div>
            `;
            
            notificationsContainer.prepend(notification);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 5000);
        }

        // Show loading overlay
        function showLoading() {
            loadingOverlay.classList.remove('hidden');
        }

        // Hide loading overlay
        function hideLoading() {
            loadingOverlay.classList.add('hidden');
        }

        // Simulate team request sent
        function simulateTeamRequestSent(orderId) {
            // Show loading overlay
            loadingOverlay.classList.remove('hidden');
            
            // Simulate API call
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                addNotification(`تم إرسال طلب الموافقة للفريق للطلب`, "info");
            }, 1500);
        }

        // Simulate team notification
        function simulateTeamNotification(orderId, action) {
            // Show loading overlay
            loadingOverlay.classList.remove('hidden');
            
            // Simulate API call
            setTimeout(() => {
                loadingOverlay.classList.add('hidden');
                
                if (action === 'approved') {
                    addNotification(`تم إرسال إشعار الموافقة للفريق`, "info");
                } else {
                    addNotification(`تم إرسال إشعار الرفض للفريق`, "info");
                }
            }, 1500);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
